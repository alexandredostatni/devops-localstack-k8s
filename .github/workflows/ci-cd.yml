name: DevOps CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do código
        uses: actions/checkout@v4

      - name: Iniciar LocalStack
        uses: LocalStack/setup-localstack@v0.2.3
        with:
          image-tag: latest
          install-awslocal: "true"
          services: s3,dynamodb

      - name: Configurar Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.7

      - name: Terraform Init, Validate e Apply
        run: |
          cd infra/terraform
          terraform init
          terraform validate
          terraform apply -auto-approve
        env:
          AWS_ACCESS_KEY_ID: test
          AWS_SECRET_ACCESS_KEY: test
          AWS_DEFAULT_REGION: eu-west-1
          AWS_ENDPOINT_URL_S3: http://localhost:4566
          AWS_ENDPOINT_URL_DYNAMODB: http://localhost:4566

      - name: Configurar Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build da imagem Docker da aplicação
        run: |
          cd app
          docker build -t myapp:latest .

      - name: Instalar Kind manualmente
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.24.0/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind
          kind version

      - name: Criar cluster Kind
        run: |
          kind create cluster --name kind --wait 120s

      - name: Carregar imagem Docker no cluster Kind
        run: |
          kind load docker-image myapp:latest --name kind

      - name: Instalar kubectl (se necessário)
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Criar namespace monitoring
        run: |
          kubectl create namespace monitoring --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy da aplicação e monitoramento no Kubernetes
        run: |
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml
          kubectl apply -f k8s/prometheus/
          kubectl apply -f k8s/grafana/

      - name: Instalar Ansible
        run: |
          python3 -m pip install ansible kubernetes

      - name: Executar playbook Ansible
        run: |
          cd ansible
          ansible-playbook -i inventory.ini playbook.yml

      - name: Verificar aplicação e métricas
        run: |
          echo "Aguardando pods ficarem prontos..."
          kubectl wait --for=condition=ready pod -l app=myapp --timeout=180s
          kubectl wait --for=condition=ready pod -l app=prometheus -n monitoring --timeout=180s || true

          echo "Testando endpoint de métricas..."
          kubectl port-forward svc/myapp-service 8000:80 > /dev/null 2>&1 &
          sleep 15
          curl -f http://localhost:8000/metrics && echo "Métricas OK!" || echo "Métricas não disponíveis ainda (normal no primeiro run)"

      - name: Pipeline concluído com sucesso
        run: echo "Todo o pipeline DevOps local executou com sucesso no GitHub Actions!"
