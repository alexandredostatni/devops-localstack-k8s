name: DevOps CI/CD

on:
  push:
  pull_request:

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Start LocalStack
        id: localstack
        uses: LocalStack/setup-localstack@v0.1.5
        with:
          image-tag: '3.0'
          services: s3,dynamodb
          port: 4566

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init and Apply
        env:
          AWS_ACCESS_KEY_ID: test
          AWS_SECRET_ACCESS_KEY: test
          AWS_DEFAULT_REGION: us-east-1
          AWS_ENDPOINT_URL_S3: http://localhost:4566
          AWS_ENDPOINT_URL_DYNAMODB: http://localhost:4566
        run: |
          cd infra/terraform
          terraform init
          terraform validate
          terraform apply -auto-approve

      - name: Build Docker Image
        run: |
          cd app
          docker build -t myapp:latest .

      - name: Set up Kind
        uses: helm/kind-action@v1.10.0
        with:
          cluster_name: devops-cluster

      - name: Verify Kind cluster is running
        run: |
          kind get clusters
          kubectl get nodes

      - name: Expose LocalStack to Kind network
        run: |
          LOCALSTACK_CONTAINER=$(docker ps --filter "ancestor=localstack/localstack" --format "{{.ID}}")
          docker network connect kind $LOCALSTACK_CONTAINER || true

      - name: Load Image to Kind
        run: |
          kind load docker-image myapp:latest --name devops-cluster

      - name: Create namespaces
        run: |
          kubectl create namespace monitoring --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy to Kubernetes
        run: |
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml
          kubectl apply -f k8s/prometheus/
          kubectl apply -f k8s/grafana/

      - name: Install Ansible dependencies
        run: |
          pip install ansible kubernetes
          ansible-galaxy collection install kubernetes.core

      - name: Run Ansible Playbook
        run: |
          cd ansible
          ansible-playbook -i inventory.ini playbook.yml

      - name: Wait for app pod to be ready (with better debugging)
        run: |
          echo "Aguardando pods ficarem prontos..."
          kubectl get pods -l app=myapp

          for i in {1..30}; do
            if kubectl wait --for=condition=ready pod -l app=myapp --timeout=10s; then
              echo "Pod está ready!"
              exit 0
            else
              echo "Tentativa $i/30: Pod ainda não está ready"
              kubectl get pods -l app=myapp
              kubectl logs -l app=myapp --tail=50 || true
              kubectl describe pod -l app=myapp || true
              sleep 10
            fi
          done

          echo "ERRO: Pod não ficou ready após 5 minutos"
          exit 1

      - name: Verify metrics endpoint
        run: |
          kubectl port-forward svc/myapp-service 8000:80 >/dev/null 2>&1 &
          sleep 5
          curl -f http://localhost:8000/metrics | head -20
