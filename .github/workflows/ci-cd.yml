name: DevOps CI/CD

on: [push, pull_request]

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Start LocalStack
        uses: localstack/setup-localstack@v0.2.0
        with:
          image-tag: latest

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v2

      - name: Terraform Init and Apply
        run: |
          cd infra/terraform
          terraform init
          terraform validate
          terraform apply -auto-approve
        env:
          AWS_ENDPOINT_URL: http://localhost:4566
          AWS_ACCESS_KEY_ID: test
          AWS_SECRET_ACCESS_KEY: test

      - name: Set up Docker
        uses: docker/setup-buildx-action@v2

      - name: Build Docker Image
        run: |
          cd app
          docker build -t myapp:latest .

      - name: Set up Kind
        uses: helm/kind-action@v1.8.0

      - name: Load Image to Kind
        run: kind load docker-image myapp:latest

      - name: Deploy to Kubernetes
        run: |
          kubectl create namespace monitoring || true
          kubectl apply -f k8s/

      - name: Set up Ansible
        run: pip install ansible kubernetes

      - name: Run Ansible
        run: |
          cd ansible
          ansible-playbook -i inventory.ini playbook.yml

      - name: Verify Monitoring
        run: |
          kubectl wait --for=condition=ready pod -l app=myapp --timeout=120s
          kubectl wait --for=condition=ready pod -l app=prometheus -n monitoring --timeout=120s
          # Simple test: Check if metrics endpoint responds
          kubectl port-forward svc/myapp-service 8000:80 & sleep 5
          curl http://localhost:8000/metrics | grep http_requests_total

# Inline explanation: Idempotent steps (e.g., || true for namespaces). Secure: Uses env vars for creds. Focused on learning: Full pipeline in one job.
