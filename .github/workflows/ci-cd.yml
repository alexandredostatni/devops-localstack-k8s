name: DevOps CI/CD

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    env:
      AWS_ACCESS_KEY_ID: test
      AWS_SECRET_ACCESS_KEY: test
      AWS_DEFAULT_REGION: us-east-1
      AWS_ENDPOINT_URL: http://localhost:4566

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Start LocalStack
        uses: LocalStack/setup-localstack@v0.2.3
        with:
          services: s3,dynamodb
          install-awslocal: true

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init & Apply
        run: |
          cd infra/terraform
          terraform init
          terraform validate
          terraform apply -auto-approve

      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          cd app
          docker build -t myapp:latest .

      - name: Create Kind cluster
        uses: helm/kind-action@v1.8.0
        with:
          cluster name: kind

      - name: Load image into Kind
        run: kind load docker-image myapp:latest

      - name: Deploy to Kubernetes
        run: |
          kubectl create namespace monitoring || true
          kubectl apply -f k8s/

      - name: Install Ansible
        run: pip install ansible kubernetes

      - name: Run Ansible playbook
        run: |
          cd ansible
          ansible-playbook -i inventory.ini playbook.yml

      - name: Verify application
        run: |
          kubectl wait --for=condition=ready pod -l app=myapp --timeout=120s

      - name: Install Ansible dependencies
        run: |
          pip install ansible kubernetes
          ansible-galaxy collection install kubernetes.core
